\appendix

\chapter{Függelék}\label{fuxfcggeluxe9k}

\section{Dockerfile-ok}\label{dockerfile-ok}

\subsection{Authentikáció}\label{authentikuxe1ciuxf3}

Dockerfile.auth.service

```\{Dockerfile\} FROM ubuntu MAINTAINER Borlay Dániel
\href{mailto:borlay.daniel@gmail.com}{borlay.daniel@gmail.com}

COPY auth.sh /usr/sbin/auth.sh COPY auth-service.py
/usr/sbin/auth-service.py

RUN apt-get -y update RUN apt-get -y install vim bash python-oauth
python-mysqldb python\\ python-flask RUN chmod +x /usr/sbin/auth.sh RUN
chmod +x /usr/sbin/auth-service.py

EXPOSE 8081 ```

\subsection{Proxy}\label{proxy}

Dockerfile.proxy.service

```\{Dockerfile\} FROM haproxy MAINTAINER Borlay Dániel
\href{mailto:borlay.daniel@gmail.com}{borlay.daniel@gmail.com}

COPY proxy.sh /usr/sbin/proxy.sh

RUN apt-get -y update RUN apt-get -y install vim haproxy RUN chmod +x
/usr/sbin/proxy.sh COPY haproxy.cfg /etc/haproxy/haproxy.cfg

ENTRYPOINT proxy.sh

EXPOSE 8080 ```

\subsection{Adatbázis}\label{adatbuxe1zis}

Dockerfile.database.service

```\{Dockerfile\} FROM ubuntu MAINTAINER Borlay Dániel
\href{mailto:borlay.daniel@gmail.com}{borlay.daniel@gmail.com}

COPY database.sh /usr/sbin/database.sh COPY auth\_init.sql
/tmp/auth\_init.sql COPY bookstore\_init.sql /tmp/bookstore\_init.sql

RUN apt-get -y update RUN apt-get -y install mysql-server mysql-client
vim RUN chmod +x /usr/sbin/database.sh RUN sed -i
`s/bind-address.\emph{=.}/bind-address = 0.0.0.0/g' /etc/mysql/my.cnf

EXPOSE 3306 ```

\subsection{Vásárlás}\label{vuxe1suxe1rluxe1s}

Dockerfile.reserve.service

```\{Dockerfile\} FROM centos MAINTAINER Borlay Dániel
\href{mailto:borlay.daniel@gmail.com}{borlay.daniel@gmail.com}

COPY reserve.sh /usr/sbin/reserve.sh

RUN yum -y update RUN yum -y install vim java-1.8.0-openjdk-devel
tomcat7 RUN chmod +x /usr/sbin/reserve.sh

EXPOSE 8888 ```

\subsection{Webkiszolgáló
(böngészés)}\label{webkiszolguxe1luxf3-buxf6nguxe9szuxe9s}

Dockerfile.webserver.service

```\{Dockerfile\} FROM httpd MAINTAINER Borlay Dániel
\href{mailto:borlay.daniel@gmail.com}{borlay.daniel@gmail.com}

COPY webserver.sh /usr/sbin/webserver.sh COPY index.html
/var/www/html/index.html COPY login.php /var/www/html/login.php COPY
store.php /var/www/html/store.php

RUN apt-get -y update RUN apt-get -y install vim php5 php5-mysql curl
php5-curl RUN chmod +x /usr/sbin/webserver.sh

EXPOSE 80 443 ```

\section{Szkriptek}\label{szkriptek}

\subsection{Futtatáshoz}\label{futtatuxe1shoz}

\subsubsection{Build}\label{build}

build\_docker.sh

```\{bash\} \#!/bin/bash

services=``database webserver proxy reserve auth''

for service in ${services} do     echo "Create $\{service\} for
bookstore \ldots{}" mkdir -p
services/${service}     cp Dockerfiles/Dockerfile.$\{service\}.service
services/${service}/Dockerfile     cp -R scripts/$\{service\}/*
services/${service}/     docker build -t bookstore_$\{service\}
services/${service} \
      &> services/$\{service\}/build.log done

echo ``Microservices has been created!'' ```

\subsubsection{Futtatás}\label{futtatuxe1s}

run\_containers.sh

```\{bash\} \#!/bin/bash

services=``database webserver reserve auth proxy''

docker network create bookstore

for service in ${services} do     echo "Start $\{service\} service
\ldots{}" docker run -d --name ``${service}" -h "$\{service\}''\\
--net=bookstore bookstore\_${service} $\{service\}.sh
``\$\{DOCKER\_IP\_HAPROXY\}'' done ```

\subsubsection{Tisztogatás}\label{tisztogatuxe1s}

clean\_docker.sh

```\{bash\} \#!/bin/bash

services=``database webserver proxy reserve auth''

docker stop \$(docker ps -a \textbar{} awk `/bookstore/ \{print
$1}') docker rm $(docker ps -a \textbar{} awk'/bookstore/ \{print
\$1\}')

for service in ${services} do     echo "Delete $\{service\} image"
docker rmi bookstore\_\$\{service\} done

rm -rf services docker network rm bookstore ```

\subsection{Szolgáltatásokhoz}\label{szolguxe1ltatuxe1sokhoz}

\subsubsection{Adatbázis
inicializálás}\label{adatbuxe1zis-inicializuxe1luxe1s}

Authentikáció:

\texttt{\{SQL\} \# Add permission to databases GRANT ALL PRIVILEGES ON authenticate.* TO 'root'@'\%'; GRANT ALL PRIVILEGES ON authenticate.* TO 'root'@'localhost'; \# Create Tables CREATE TABLE user\_auth (     user\_id int NOT NULL AUTO\_INCREMENT,     username varchar(255) NOT NULL,     password varchar(255) NOT NULL,     credential varchar(255),     PRIMARY KEY (user\_id) ); \# Fill Tables INSERT INTO user\_auth (username, password) VALUES ("test", "testpassword");}

Bookstore raktár:

\texttt{\{SQL\} \# Add permission to databases GRANT ALL PRIVILEGES ON bookstore.* TO 'root'@'\%'; GRANT ALL PRIVILEGES ON bookstore.* TO 'root'@'localhost'; \# Create Tables CREATE TABLE store (     store\_id int NOT NULL AUTO\_INCREMENT,     book\_name varchar(255) NOT NULL,     count int NOT NULL,     PRIMARY KEY (store\_id) ); CREATE TABLE reservation (     reservation\_id int NOT NULL AUTO\_INCREMENT,     username varchar(255) NOT NULL,     book\_name varchar(255) NOT NULL,     count int NOT NULL,     res\_date varchar(255),     PRIMARY KEY (reservation\_id) ); \# Fill Tables INSERT INTO store (book\_name, count) VALUES ("Harry Potter and the Goblet of fire", 10); INSERT INTO store (book\_name, count) VALUES ("Harry Potter and the Philosopher's Stone", 10); INSERT INTO store (book\_name, count) VALUES ("Harry Potter and the Chamber of Secret", 10); INSERT INTO store (book\_name, count) VALUES ("Lord of the Rings: Fellowship of the ring", 3); INSERT INTO store (book\_name, count) VALUES ("Lord of the Rings: The Two Towers", 3); INSERT INTO store (book\_name, count) VALUES ("Lord of the Rings: The Return of the King", 0);}

\subsubsection{Bejelentkezéshez}\label{bejelentkezuxe9shez}

login.php:

```\{PHP\} ```

auth-service.py:

```\{python\} \#!/usr/bin/env python from flask import Flask, abort
import MySQLdb as mdb app = Flask(\textbf{name})

@app.route(``/auth//'') def hello(username, password): try: con =
mdb.connect(`database', `root', `', 'authenticate'); cur = con.cursor()
cur.execute(``SELECT user\_id FROM user\_auth\\ WHERE username=`\%s' AND
password=`\%s'\,'' \% (username, password)) user\_id = cur.fetchone()
print user\_id if not user\_id: abort(401) except mdb.Error, e: print
``Error \%d: \%s'' \% (e.args{[}0{]},e.args{[}1{]}) abort(401) finally:
if con: con.close() return ``Successfully authenticated!''

if \textbf{name} == ``\textbf{main}'': app.run(host=``0.0.0.0'',
port=8081) ```

\subsubsection{Böngészés}\label{buxf6nguxe9szuxe9s}

index.html:

```\{HTML\}

Bookstore Microservice

Login:

Username

Password

```

store.php:

```\{PHP\}

Bookstore Microservice

Books:

Name

Quantity

\begin{verbatim}
<?php
  $servername = "database";
  $username = "root";
  $password = "";
  $dbname = "bookstore";

  // Create connection
  $conn = new mysqli($servername, $username, $password, $dbname);
  // Check connection
  if ($conn->connect_error) {
      die("Connection failed: " . $conn->connect_error);
  }

  $sql = "SELECT * FROM store";
  $result = $conn->query($sql);

  if ($result->num_rows > 0) {
      // output data of each row
      while($row = $result->fetch_assoc()) {
          echo "<tr><td>" . $row["book_name"]. \
          "</td><td> " . $row["count"]. "</td></tr>";
      }
  } else {
      echo "0 results";
  }
  $conn->close();
?>
\end{verbatim}

```

Proxy config:

```\{config\}

frontend web bind *:80 mode http default\_backend nodes

backend nodes mode http balance roundrobin server webserver webserver:80
cookie check ```
